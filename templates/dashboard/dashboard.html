{% extends 'base.html' %}
{% load static %}
{% block title %} Map Layer View {% endblock %}

{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload and Render Shapefile</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="{% static 'css/toggle-sidebar.css' %}" rel="stylesheet">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shpjs/dist/shp.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
{% endblock %}

{% block body %}
<div class="wrapper">
    <aside id="sidebar">
        <div class="d-flex">
            <button class="toggle-btn" type="button">
                <i class="lni lni-grid-alt"></i>
            </button>
            <div class="sidebar-logo">
                <a href="#">Map Layer</a>
            </div>
        </div>
        <ul class="sidebar-nav">
            <li class="sidebar-item">
                <a href="#" class="sidebar-link">
                    <span><div id="layerToggle"></div></span>
                </a>
            </li>
        </ul>
    </aside>
    <div class="main">
        <div id="map" style="width: 100%; height: 800px;"></div>
    </div>
    <aside id="sidebar2">
        <div class="d-flex">
            <button class="toggle-btn2" type="button">
                <i class="lni lni-grid-alt"></i>
            </button>
            <div class="sidebar2-logo">
                <a href="#">Selected Attributes</a>
            </div>
        </div>
        <ul class="sidebar-nav">
            <li class="sidebar-item">
                <a href="#" class="sidebar2-link">
                    <span>
                        Full Screen<button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#attributeModal">
                            <i class="fas fa-expand"></i>
                        </button>
                    </span>
                </a>
            </li>
            <div id="attributeTableContainer">
                <table>
                    <thead>
                        <tr><th>Attribute</th><th>Value</th></tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="2">Click on a feature to see its attributes</td></tr>
                    </tbody>
                </table>
            </div>
        </ul>
    </aside>
    
    <!-- Modal -->
    <div class="modal fade" id="attributeModal" tabindex="-1" aria-labelledby="attributeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attributeModalLabel">Attributes Table</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modalAttributeTableContainer"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        #attributeTableContainer {
            margin: 15px;
        }
        #attributeTableContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        
        #fullscreenButton {
            margin: 10px;
            padding: 5px 10px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
        }
        #fullscreenButton:hover {
            background-color: #0056b3;
        }
        #attributeTableContainer:fullscreen {
            width: 100%;
            height: 100%;
            background-color: white;
            overflow: auto;
        }
    </style>
</div>

<script>
    var map = L.map('map').setView([23.999941, 90.420273], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var loadedLayers = [];
    var highlightedFeatureLayers = [];

    function loadGeoJSON(geojsonContent, fileName) {
        try {
            var geojson = JSON.parse(geojsonContent);
            var layer = L.geoJSON(geojson, {
                onEachFeature: onEachFeature
            });
            layer.addTo(map);
            map.fitBounds(layer.getBounds());
            loadedLayers.push({ name: fileName, layer: layer });
            updateLayerToggle();
        } catch (error) {
            console.error("Error loading GeoJSON:", error);
            alert("Error loading GeoJSON. Please make sure the file is valid.");
        }
    }

    function loadShapefile(fileContent, fileName) {
        shp(fileContent).then(function(geojson) {
            var layer = L.geoJSON(geojson, {
                onEachFeature: onEachFeature
            });
            layer.addTo(map);
            map.fitBounds(layer.getBounds());
            loadedLayers.push({ name: fileName, layer: layer });
            updateLayerToggle();
        }).catch(function(error) {
            console.error("Error loading Shapefile:", error);
            alert("Error loading Shapefile. Please make sure the files are valid.");
        });
    }

    function loadKMLfile(kmlContent, fileName) {
        try {
            var parser = new DOMParser();
            var kmlDoc = parser.parseFromString(kmlContent, "application/xml");
            var layerGroup = L.layerGroup();
            var allCoordinates = [];

            var placemarks = kmlDoc.getElementsByTagName("Placemark");
            for (var i = 0; i < placemarks.length; i++) {
                var placemark = placemarks[i];
                var points = placemark.getElementsByTagName("Point");
                var lineStrings = placemark.getElementsByTagName("LineString");
                var polygons = placemark.getElementsByTagName("Polygon");

                var processCoordinates = function(coordinates) {
                    var coordinatesArray = coordinates.split(/\s+/).map(coord => coord.split(',').map(parseFloat));
                    allCoordinates.push(...coordinatesArray);
                    var latLngArray = coordinatesArray.map(coord => [coord[1], coord[0]]);
                    return latLngArray;
                };

                for (var j = 0; j < points.length; j++) {
                    var coordinates = points[j].getElementsByTagName("coordinates")[0].textContent.trim();
                    var latLngArray = processCoordinates(coordinates);
                    L.marker(latLngArray[0]).addTo(layerGroup);
                }

                for (var j = 0; j < lineStrings.length; j++) {
                    var coordinates = lineStrings[j].getElementsByTagName("coordinates")[0].textContent.trim();
                    var latLngArray = processCoordinates(coordinates);
                    L.polyline(latLngArray, { color: 'blue' }).addTo(layerGroup);
                }

                for (var k = 0; k < polygons.length; k++) {
                    var coordinates = polygons[k].getElementsByTagName("outerBoundaryIs")[0]
                                    .getElementsByTagName("LinearRing")[0]
                                    .getElementsByTagName("coordinates")[0].textContent.trim();
                    var latLngArray = processCoordinates(coordinates);
                    L.polygon(latLngArray, { color: 'blue' }).addTo(layerGroup);
                }
            }

            layerGroup.addTo(map);
            if (allCoordinates.length > 0) {
                map.fitBounds(L.latLngBounds(allCoordinates.map(coord => [coord[1], coord[0]])));
            }

            loadedLayers.push({ name: fileName, layer: layerGroup });
            updateLayerToggle();
        } catch (error) {
            console.error("Error loading KML:", error);
            alert("Error loading KML. Please make sure the file is valid.");
        }
    }

    function loadCSVfile(csvContent, fileName) {
        try {
            var rows = csvContent.trim().split('\n');
            var headers = rows[0].split(',');
            var features = [];
            var latIndex = headers.indexOf("lat");
            var lonIndex = headers.indexOf("lng");

            if (latIndex === -1 || lonIndex === -1) {
                console.error("Latitude or longitude header not found in CSV.");
                alert("Latitude or longitude header not found in CSV. Please make sure the file is valid.");
                return;
            }

            for (var i = 1; i < rows.length; i++) {
                var values = rows[i].split(',');
                var latitude = parseFloat(values[latIndex]);
                var longitude = parseFloat(values[lonIndex]);

                if (isNaN(latitude) || isNaN(longitude)) {
                    console.error("Invalid latitude or longitude value:", latitude, longitude);
                    continue;
                }

                var properties = {};
                for (var j = 0; j < headers.length; j++) {
                    properties[headers[j]] = values[j];
                }

                var feature = {
                    type: "Feature",
                    properties: properties,
                    geometry: {
                        type: "Point",
                        coordinates: [longitude, latitude]
                    }
                };
                features.push(feature);
            }

            var geojson = {
                type: "FeatureCollection",
                features: features
            };

            var layer = L.geoJSON(geojson, {
                onEachFeature: onEachFeature
            }).addTo(map);
            map.fitBounds(layer.getBounds());

            loadedLayers.push({ name: fileName, layer: layer });
            updateLayerToggle();
        } catch (error) {
            console.error("Error loading CSV:", error);
            alert("Error loading CSV. Please make sure the file is valid.");
        }
    }

    function loadShapefileFromUrl(url) {
        var fileExtension = url.split('.').pop().toLowerCase();

        if (fileExtension === 'geojson') {
            fetch(url)
                .then(response => response.json())
                .then(geojson => {
                    loadGeoJSON(JSON.stringify(geojson), url);
                })
                .catch(error => {
                    console.error("Error fetching GeoJSON:", error);
                    alert("Error fetching GeoJSON. Please make sure the URL is correct.");
                });
        } else if (fileExtension === 'zip') {
            fetch(url)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    loadShapefile(arrayBuffer, url);
                })
                .catch(error => {
                    console.error("Error fetching Shapefile:", error);
                    alert("Error fetching Shapefile. Please make sure the URL is correct.");
                });
        } else if (fileExtension === 'csv') {
            fetch(url)
                .then(response => response.text())
                .then(csvContent => {
                    loadCSVfile(csvContent, url);
                })
                .catch(error => {
                    console.error("Error fetching CSV file:", error);
                    alert("Error fetching CSV file. Please make sure the URL is correct.");
                });
        } else if (fileExtension === 'kml') {
            fetch(url)
                .then(response => response.text())
                .then(kmlContent => {
                    loadKMLfile(kmlContent, url);
                })
                .catch(error => {
                    console.error("Error fetching KML file:", error);
                    alert("Error fetching KML file. Please make sure the URL is correct.");
                });
        } else {
            console.error("Unsupported file format:", fileExtension);
            alert("Unsupported file format. Please make sure the file format is either GeoJSON, Shapefile, CSV, or KML.");
        }
    }

    {% for url in mapfile %}
    loadShapefileFromUrl('{{ url }}');
    {% endfor %}
    
//........................................
function updateLayerToggle() {
    var layerToggleDiv = document.getElementById("layerToggle");
    layerToggleDiv.innerHTML = ""; // Clear existing checkboxes
    loadedLayers.forEach(function (loadedLayer, index) {
        var checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true; // Default to visible
        checkbox.id = "layerToggleCheckbox" + index;
        checkbox.style.marginRight = "5px"; // Add padding to the right
        checkbox.style.accentColor = "#007279"; // Set background color
        checkbox.onchange = function () {
            if (this.checked) {
                map.addLayer(loadedLayer.layer);
            } else {
                map.removeLayer(loadedLayer.layer);
            }
        };
        var label = document.createElement("label");
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(getFileName(loadedLayer.name))); // Get file name

        var container = document.createElement("div"); // Create a container for each checkbox and label
        container.appendChild(label);

        layerToggleDiv.appendChild(container); // Append the container
        layerToggleDiv.appendChild(document.createElement("br"));
    });
}

function getFileName(path) {
    var fileNameWithExtension = path.split("/").pop(); // Assuming path uses forward slash as separator
    var fileNameWithoutExtension = fileNameWithExtension.split(".")[0]; // Remove file extension
    var fileNameWithSpaces = fileNameWithoutExtension.replace(/_/g, " "); // Remove underscores and add spaces
    return fileNameWithSpaces;
}

function onEachFeature(feature, layer) {
    // Bind a popup with feature properties
    if (feature.properties) {
        var popupContent = '<table>';
        for (var key in feature.properties) {
            if (feature.properties.hasOwnProperty(key)) {
                popupContent += '<tr><td><strong>' + key + ':</strong></td><td>' + feature.properties[key] + '</td></tr>';
            }
        }
        popupContent += '</table>';
        layer.bindPopup(popupContent);
    }

    // Add click event to toggle feature selection
    layer.on('click', function (e) {
        toggleFeatureSelection(feature, layer);
    });
}

function toggleFeatureSelection(feature, layer) {
    var index = highlightedFeatureLayers.findIndex(function (hl) {
        return hl.feature === feature;
    });

    if (index === -1) {
        highlightFeature(layer, feature);
        highlightedFeatureLayers.push({ feature: feature, layer: layer, highlightLayer: layer.highlightLayer });
    } else {
        map.removeLayer(highlightedFeatureLayers[index].highlightLayer);
        highlightedFeatureLayers.splice(index, 1);
    }

    updateAttributeTable();
}

function highlightFeature(layer, feature) {
    var highlightLayer = L.geoJSON(feature, {
        style: function (geoJsonFeature) {
            return {
                color: 'red',
                weight: 5,
                opacity: 1,
                fillOpacity: 0.7
            };
        },
        pointToLayer: function (geoJsonPoint, latlng) {
            return L.circleMarker(latlng, {
                radius: 8,
                color: 'red',
                fillColor: 'red',
                fillOpacity: 0.8
            });
        },
        onEachFeature: function (feature, layer) {
            // Bind a popup with feature properties
            if (feature.properties) {
                var popupContent = '<table>';
                for (var key in feature.properties) {
                    if (feature.properties.hasOwnProperty(key)) {
                        popupContent += '<tr><td><strong>' + key + ':</strong></td><td>' + feature.properties[key] + '</td></tr>';
                    }
                }
                popupContent += '</table>';
                layer.bindPopup(popupContent);
            }
        }
    }).addTo(map);

    layer.highlightLayer = highlightLayer;
}

function stripHTML(html) {
    var div = document.createElement("div");
    div.innerHTML = html;
    return div.textContent || div.innerText || "";
}

function parseDescriptionHTML(html) {
    var parser = new DOMParser();
    var doc = parser.parseFromString(html, 'text/html');
    var rows = Array.from(doc.querySelectorAll("tr"));
    var parsedData = {};

    rows.forEach(row => {
        var cells = row.querySelectorAll("td");
        if (cells.length === 2) {
            var key = stripHTML(cells[0].innerHTML);
            var value = stripHTML(cells[1].innerHTML);
            parsedData[key] = value;
        }
    });

    return parsedData;
}

function updateAttributeTable() {
    var tbody = document.querySelector("#attributeTableContainer tbody");
    var modalTbody = document.querySelector("#modalAttributeTableContainer");
    tbody.innerHTML = '';
    modalTbody.innerHTML = '';
    
    highlightedFeatureLayers.forEach(function (hl, featureIndex) {
        var properties = hl.feature.properties;
        for (var key in properties) {
            if (properties.hasOwnProperty(key)) {
                var value = properties[key];
                if (key === "description") {
                    var parsedDescription = parseDescriptionHTML(value);
                    for (var descKey in parsedDescription) {
                        if (parsedDescription.hasOwnProperty(descKey)) {
                            addTableRow(tbody, modalTbody, descKey, parsedDescription[descKey]);
                        }
                    }
                } else {
                    addTableRow(tbody, modalTbody, key, value);
                }
            }
        }

        // Add an empty row to create a gap between features
        if (featureIndex < highlightedFeatureLayers.length - 1) {
            addGapRow(tbody, modalTbody);
        }
    });
}


function addTableRow(tbody, modalTbody, key, value) {
    var row = document.createElement('tr');
    var modalRow = document.createElement('tr');
    var cellKey = document.createElement('td');
    var cellValue = document.createElement('td');
    var modalCellKey = document.createElement('td');
    var modalCellValue = document.createElement('td');
    cellKey.textContent = key;
    cellValue.textContent = value;
    modalCellKey.textContent = key;
    modalCellValue.textContent = value;
    row.appendChild(cellKey);
    row.appendChild(cellValue);
    modalRow.appendChild(modalCellKey);
    modalRow.appendChild(modalCellValue);
    tbody.appendChild(row);
    modalTbody.appendChild(modalRow);
}

function addGapRow(tbody, modalTbody) {
    var gapRow = document.createElement('tr');
    gapRow.classList.add('gap-row');
    var gapCell = document.createElement('td');
    gapCell.colSpan = 2;
    gapCell.style.height = '20px'; // Adjust the height as needed
    gapRow.appendChild(gapCell);
    tbody.appendChild(gapRow);

    var modalGapRow = document.createElement('tr');
    modalGapRow.classList.add('gap-row');
    var modalGapCell = document.createElement('td');
    modalGapCell.colSpan = 2;
    modalGapCell.style.height = '20px'; // Adjust the height as needed
    modalGapRow.appendChild(modalGapCell);
    modalTbody.appendChild(modalGapRow);
}

const hamBurger = document.querySelector(".toggle-btn");
const hamBurger2 = document.querySelector(".toggle-btn2");

function expandSidebar() {
    document.querySelector("#sidebar").classList.add("expand");
}

function expandSidebar2() {
    document.querySelector("#sidebar2").classList.add("expand");
}

expandSidebar();
expandSidebar2();

hamBurger.addEventListener("click", function () {
    document.querySelector("#sidebar").classList.toggle("expand");
});

hamBurger2.addEventListener("click", function () {
    document.querySelector("#sidebar2").classList.toggle("expand");
});

</script>

{% endblock %}
