{% extends 'base.html' %}
{% load static %}
{% block title %}System Backups - GIS Portal{% endblock %}

{% block head %}
<title>System Backups</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block body %}
<section class="py-3 py-md-5" style="background-image: url('/media/gis-map-gallery-bg.webp'); 
                                    background-size: cover; 
                                    background-position: center;
                                    min-height: 100vh;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12">
        
        <!-- Header -->
        <div class="text-center mb-5">
          <h1 class="display-4 text-white mb-3">
            <i class="fas fa-database me-3"></i>System Backups
          </h1>
          <p class="lead text-light">Manage your system backups and restorations</p>
        </div>

        <!-- Action Buttons -->
        <div class="row mb-4">
          <div class="col-12 text-center">
            <a href="{% url 'Login:create_backup' %}" class="btn btn-primary btn-lg me-3 mb-2">
              <i class="fas fa-plus-circle me-2"></i>Create New Backup
            </a>
            <a href="{% url 'Login:upload_backup' %}" class="btn btn-success btn-lg me-3 mb-2">
              <i class="fas fa-upload me-2"></i>Upload Backup
            </a>
            <a href="{% url 'Login:dashboard' %}" class="btn btn-secondary btn-lg mb-2">
              <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
          </div>
        </div>

        <!-- Messages -->
        {% if messages %}
          {% for message in messages %}
            <div class="alert {% if 'success' in message.tags %}alert-success{% elif 'error' in message.tags %}alert-danger{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
              {{ message|safe }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}

        <!-- Backup List -->
        <div class="card shadow-lg">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Backup History</h5>
          </div>
          <div class="card-body p-0">
            {% if backups %}
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-dark">
                    <tr>
                      <th><i class="fas fa-tag me-1"></i>Name</th>
                      <th><i class="fas fa-layer-group me-1"></i>Type</th>
                      <th><i class="fas fa-info-circle me-1"></i>Status</th>
                      <th><i class="fas fa-weight-hanging me-1"></i>Size</th>
                      <th><i class="fas fa-clock me-1"></i>Created</th>
                      <th><i class="fas fa-user me-1"></i>By</th>
                      <th><i class="fas fa-cogs me-1"></i>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for backup in backups %}
                      <tr>
                        <td>
                          <strong>{{ backup.name }}</strong>
                          {% if backup.description %}
                            <br><small class="text-muted">{{ backup.description|truncatechars:50 }}</small>
                          {% endif %}
                        </td>
                        <td>
                          <span class="badge bg-info">{{ backup.get_backup_type_display }}</span>
                        </td>
                        <td>
                          {% if backup.status == 'completed' %}
                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Completed</span>
                          {% elif backup.status == 'failed' %}
                            <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Failed</span>
                          {% elif backup.status == 'in_progress' %}
                            <span class="badge bg-warning"><i class="fas fa-spinner fa-spin me-1"></i>In Progress</span>
                          {% else %}
                            <span class="badge bg-secondary"><i class="fas fa-clock me-1"></i>Pending</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if backup.file_size_mb %}
                            {{ backup.file_size_mb }} MB
                          {% else %}
                            <span class="text-muted">-</span>
                          {% endif %}
                        </td>
                        <td>
                          <div>{{ backup.created_at|date:"M d, Y" }}</div>
                          <small class="text-muted">{{ backup.created_at|time:"H:i" }}</small>
                        </td>
                        <td>{{ backup.created_by.username }}</td>
                        <td>
                          <div class="btn-group btn-group-sm" role="group">
                            {% if backup.status == 'completed' and backup.file_exists %}
                              <a href="{% url 'Login:download_backup' backup.id %}" 
                                 class="btn btn-outline-primary" 
                                 title="Download">
                                <i class="fas fa-download"></i>
                              </a>
                              <a href="{% url 'Login:restore_backup' backup.id %}" 
                                 class="btn btn-outline-warning" 
                                 title="Restore"
                                 onclick="return confirm('Are you sure you want to restore this backup? This will overwrite current data.')">
                                <i class="fas fa-undo"></i>
                              </a>
                            {% endif %}
                            <form method="post" action="{% url 'Login:delete_backup' backup.id %}" class="d-inline">
                              {% csrf_token %}
                              <button type="submit" 
                                      class="btn btn-outline-danger" 
                                      title="Delete"
                                      onclick="return confirm('Are you sure you want to delete this backup?')">
                                <i class="fas fa-trash"></i>
                              </button>
                            </form>
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="text-center py-5">
                <i class="fas fa-database fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No backups found</h5>
                <p class="text-muted">Create your first backup to get started.</p>
                <a href="{% url 'Login:create_backup' %}" class="btn btn-primary">
                  <i class="fas fa-plus me-2"></i>Create Backup
                </a>
              </div>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

<style>
.table th {
  border-top: none;
  font-weight: 600;
}

.btn-group-sm .btn {
  padding: 0.25rem 0.5rem;
}

.card {
  border: none;
  border-radius: 15px;
}

.card-header {
  border-radius: 15px 15px 0 0 !important;
}

.badge {
  font-size: 0.75em;
}

.table-responsive {
  border-radius: 0 0 15px 15px;
}

@media (max-width: 768px) {
  .btn-lg {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
  }
  
  .display-4 {
    font-size: 2rem;
  }
}
</style>
{% endblock %}